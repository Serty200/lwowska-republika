<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Wybory - Lwowska Republika</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2 { color: #004080; }
    .question { margin-bottom: 20px; }
    .results { margin-top: 30px; }
    button { padding: 10px 20px; margin-top: 10px; cursor: pointer; }
    .admin-panel { margin-top: 50px; background: #eef; padding: 20px; border-radius: 8px; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; }
    .success-message { color: green; font-weight: bold; margin-top: 10px; }
    .archive { margin-top: 50px; padding: 20px; background: #fff4e6; border-radius: 8px; }
    .filter-section { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üó≥ Wybory Lwowskiej Republiki</h1>
    <div id="voteSection"></div>
    <div class="results" id="publicResults">
      <h2>Wyniki</h2>
      <div id="resultsSection">Brak g≈Ços√≥w.</div>
    </div>
    <div class="archive">
      <h2>üìÅ Archiwum Wybor√≥w</h2>
      <div class="filter-section">
        <label>Filtruj po tytule:</label>
        <input type="text" id="filterInput" oninput="render()">
      </div>
      <div id="archiveSection">Brak zako≈Ñczonych g≈Çosowa≈Ñ.</div>
    </div>
    <div class="admin-panel" id="adminPanel" style="display: none;">
      <h2>Panel Administracyjny - Wybory</h2>
      <label>Tytu≈Ç wybor√≥w:</label>
      <input type="text" id="electionTitle">
      <label>Dodaj pytanie:</label>
      <textarea id="newQuestion"></textarea>
      <label>Typ pytania:</label>
      <select id="questionType">
        <option value="yesno">Tak/Nie</option>
        <option value="options">Wyb√≥r spo≈õr√≥d opcji</option>
        <option value="open">W≈Çasna odpowied≈∫</option>
        <option value="singlevote">Jeden g≈Ços u≈ºytkownika</option>
      </select>
      <label id="optionsLabel" style="display:none;">Opcje (oddzielone przecinkami):</label>
      <input type="text" id="questionOptions" style="display:none;">
      <button onclick="addQuestion()">Dodaj</button>
      <div id="addSuccess" class="success-message" style="display:none;">‚úÖ Pytanie zosta≈Ço pomy≈õlnie dodane.</div>
      <h3>ZarzƒÖdzaj pytaniami</h3>
      <div id="adminQuestions"></div>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAqaPMXgvtDLl8Bu9PD5Z6g3h2uLXBkLO8",
      authDomain: "lwowska-republika.firebaseapp.com",
      projectId: "lwowska-republika",
      storageBucket: "lwowska-republika.appspot.com",
      messagingSenderId: "288907726616",
      appId: "1:288907726616:web:82c8b4aa14c12e1ca7986d",
      measurementId: "G-Y62QGV81F9",
      databaseURL: "https://lwowska-republika-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const hasloAdmin = prompt("Podaj has≈Ço administratora (pozostaw puste, je≈õli nie jeste≈õ administratorem):");
    const isAdmin = hasloAdmin === "LR2050 Zawsze Razem";
    if (isAdmin) {
      document.getElementById('adminPanel').style.display = 'block';
    }

    const questionsRef = db.ref("questions");
    const votesRef = db.ref("votes");

    function addQuestion() {
      const text = document.getElementById("newQuestion").value.trim();
      const title = document.getElementById("electionTitle").value.trim();
      const type = document.getElementById("questionType").value;
      const optionsText = document.getElementById("questionOptions").value;
      const options = (type === 'options' || type === 'singlevote') ? optionsText.split(",").map(o => o.trim()).filter(o => o !== '') : [];

      if (!text || !title) return alert("Wprowad≈∫ tytu≈Ç i tre≈õƒá pytania.");

      const newQ = { text, title, type, options };
      questionsRef.push(newQ).then(() => {
        document.getElementById("addSuccess").style.display = 'block';
        setTimeout(() => document.getElementById("addSuccess").style.display = 'none', 2000);
        document.getElementById("newQuestion").value = '';
        document.getElementById("questionOptions").value = '';
        document.getElementById("electionTitle").value = '';
        render();
      });
    }

    function render() {
      const voteSection = document.getElementById("voteSection");
      const adminQuestions = document.getElementById("adminQuestions");
      const resultsSection = document.getElementById("resultsSection");
      const archiveSection = document.getElementById("archiveSection");
      const filter = document.getElementById("filterInput").value.toLowerCase();

      questionsRef.off();
      questionsRef.on("value", snapshot => {
        const data = snapshot.val();
        voteSection.innerHTML = '';
        adminQuestions.innerHTML = '';
        resultsSection.innerHTML = '';
        archiveSection.innerHTML = '';

        if (!data) return;

        Object.entries(data).forEach(([id, q]) => {
          const archived = !!q.archivedAt;
          if (archived) {
            if (q.title.toLowerCase().includes(filter)) {
              archiveSection.innerHTML += `<p><strong>${q.title}</strong>: ${q.text} (zarchiwizowano: ${new Date(q.archivedAt).toLocaleString()})</p>`;
            }
            return;
          }

          const div = document.createElement("div");
          div.className = "question";
          div.innerHTML = `<strong>${q.title}</strong><br>${q.text}<br>`;

          if (q.type === 'yesno') {
            div.innerHTML += `<button onclick="vote('${id}', 'tak')">‚úÖ Tak</button> <button onclick="vote('${id}', 'nie')">‚ùå Nie</button>`;
          } else if (q.type === 'options' || q.type === 'singlevote') {
            q.options.forEach(opt => {
              div.innerHTML += `<button onclick="vote('${id}', '${opt}')">${opt}</button> `;
            });
          } else if (q.type === 'open') {
            div.innerHTML += `<input type="text" placeholder="Twoja odpowied≈∫" onblur="vote('${id}', this.value)">`;
          } else {
            div.innerHTML += `<em>Nieznany typ pytania</em>`;
          }

          voteSection.appendChild(div);

          if (isAdmin) {
            const adminDiv = document.createElement("div");
            adminDiv.innerHTML = `<textarea>${q.text}</textarea><br><button onclick="removeQuestion('${id}')">Usu≈Ñ</button> <button onclick="archiveQuestion('${id}')">Archiwizuj</button>`;
            adminQuestions.appendChild(adminDiv);
          }
        });
      });

      votesRef.off();
      votesRef.on("value", snap => {
        const data = snap.val();
        if (!data) return;
        Object.entries(data).forEach(([qid, qvotes]) => {
          const resLine = `<p><strong>${qid}</strong><br>${Object.entries(qvotes).filter(([k]) => k !== '_userVotes').map(([k, v]) => `${k}: ${v}`).join(" | ")}</p>`;
          if (isAdmin) resultsSection.innerHTML += resLine;
        });
      });
    }

    function vote(qid, answer) {
      if (!answer || answer.trim() === '') return;
      const userId = localStorage.getItem("userId") || (Date.now().toString(36) + Math.random().toString(36).substr(2));
      localStorage.setItem("userId", userId);
      const userVoteRef = votesRef.child(qid).child("_userVotes").child(userId);
      userVoteRef.get().then(snap => {
        if (!snap.exists()) {
          votesRef.child(qid).child(answer).get().then(s => {
            const val = s.exists() ? s.val() + 1 : 1;
            votesRef.child(qid).child(answer).set(val);
            userVoteRef.set(answer);
          });
        }
      });
    }

    function removeQuestion(qid) {
      if (confirm("Na pewno chcesz usunƒÖƒá to pytanie?")) {
        questionsRef.child(qid).remove();
        votesRef.child(qid).remove();
      }
    }

    function archiveQuestion(qid) {
      if (confirm("Zarchiwizowaƒá to pytanie?")) {
        questionsRef.child(qid).update({ archivedAt: Date.now() });
      }
    }

    document.getElementById("questionType").addEventListener("change", e => {
      const type = e.target.value;
      const show = (type === 'options' || type === 'singlevote');
      document.getElementById("optionsLabel").style.display = show ? 'block' : 'none';
      document.getElementById("questionOptions").style.display = show ? 'block' : 'none';
    });

    render();
  </script>
</body>
</html>
